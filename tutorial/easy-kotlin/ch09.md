# 第 9 章 轻量级线程：协程

- [第 9 章 轻量级线程：协程](#9)
    - [9.2 协程的基本操作](#92)
        - [9.2.2 简单协程示例](#922)
        - [9.2.5 挂起函数](#925)
        - [9.2.6 `runBlocking` 函数](#926-runblocking)
        - [9.2.7 等待一个协程任务执行完毕](#927)

配套代码 <https://github.com/EasyKotlin/chapter9_coroutines>

## 9.2 协程的基本操作

### 9.2.2 简单协程示例

```kotlin
package com.easy.kotlin

import kotlinx.coroutines.experimental.CommonPool
import kotlinx.coroutines.experimental.delay
import kotlinx.coroutines.experimental.launch
import java.util.concurrent.TimeUnit

/**
 * 9.2.2 简单协程示例
 */

fun firstCoroutineDemo0() {
    launch(CommonPool) {
        delay(3000L, TimeUnit.MILLISECONDS)
        println("Hello,")
    }
    println("World!")
    Thread.sleep(5000L)
}

fun main(args: Array<String>) {
    firstCoroutineDemo0()
}
```

输出结果

```bash
World!
Hello,
```

### 9.2.5 挂起函数

```kotlin
package com.easy.kotlin

import kotlinx.coroutines.experimental.CommonPool
import kotlinx.coroutines.experimental.delay
import kotlinx.coroutines.experimental.launch
import kotlinx.coroutines.experimental.run
import java.util.concurrent.TimeUnit

/**
 * 9.2.5 挂起函数
 */

suspend fun runCoroutineDemo() {
    run(CommonPool) {
        delay(3000L, TimeUnit.MILLISECONDS)
        println("suspend,")
    }
    println("runCoroutineDemo!")
    Thread.sleep(5000L)
}

fun callSuspendFun() {
    // 启动一个协程
    launch(CommonPool) {
        runCoroutineDemo()
    }
    // 不要让主线程那么快结束
    Thread.sleep(10000L)
}

fun main(args: Array<String>) {
    callSuspendFun()
}
```

### 9.2.6 `runBlocking` 函数

```kotlin
package com.easy.kotlin

import kotlinx.coroutines.experimental.CommonPool
import kotlinx.coroutines.experimental.delay
import kotlinx.coroutines.experimental.launch
import kotlinx.coroutines.experimental.runBlocking

/**
 * 9.2.6 runBlocking 函数
 */

fun main(args: Array<String>) = runBlocking {
    println("T0")
    launch(CommonPool) {
        println("T1")
        delay(3000L)
        println("T2 Hello,")
    }
    println("T3 World!")
    delay(5000L)
    println("T4")
}
```

### 9.2.7 等待一个协程任务执行完毕

```kotlin
package com.easy.kotlin

import kotlinx.coroutines.experimental.CommonPool
import kotlinx.coroutines.experimental.delay
import kotlinx.coroutines.experimental.launch
import kotlinx.coroutines.experimental.runBlocking

/**
 * 9.2.7 等待一个协程任务执行完毕
 */

class JoinCoroutineDemo {

    private suspend fun fc1() {
        println("[C1 Output] Thread: ${Thread.currentThread()}")
        delay(3000L)
        println("[C1 Output] 3000 End")
    }

    private suspend fun fc2() {
        println("[C2 Output] Thread: ${Thread.currentThread()}")
        delay(5000L)
        println("[C2 Output] 5000 End")
    }

    fun testJoinCoroutine() = runBlocking {

        println("[Main Output] Main Thread: ${Thread.currentThread()}")

        val c1 = launch(CommonPool) {
            fc1()
        }

        val c2 = launch(CommonPool) {
            fc2()
        }

        // 加入到主线程的时间顺序
        c1.join()
        c2.join()

        println("[Main Output] c1 isActive: ${c1.isActive}  isCompleted: ${c1.isCompleted}")
        println("[Main Output] c2 isActive: ${c2.isActive}  isCompleted: ${c2.isCompleted}")
    }
}

fun main(args: Array<String>) {
    val jcd = JoinCoroutineDemo()
    jcd.testJoinCoroutine()
}
```