[TOC]

# 第21章　模块：宏伟蓝图

> 模块是最高级别的程序组织单元，它将程序代码和数据封装起来以便重用。
> 
> 模块往往对应于Python程序文件（或是用外部语言如C、Java或C#编写而成的扩展）。每一个文件都是一个模块，并且模块导入其他模块之后就可以使用导入模块定义的变量名。

> 模块可以由两个语句和一个重要的内置函数进行处理。
> 
> import
> 使客户端（导入者）以一个整体获取一个模块。
> 
> from
> 允许客户端从一个模块文件中获取特定的变量名。
> 
> imp.reload
> 在不中止Python程序的情况下，提供了一种重新载入模块文件代码的方法。

> 模块和类实际上就是一个重要的命名空间

## 为什么使用模块

> 代码重用
> 
> 系统命名空间的划分
> 
> 实现共享服务和数据

## Python程序架构

### 如何组织一个程序

> 一般来讲，一个Python程序包括了多个含有Python语句的文本文件。程序是作为一个主体的、顶层的文件来构造的，配合有零个或多个支持的文件，在Python中这些文件称作模块。
> 
> 在Python中，顶层文件（又称为脚本）包含了程序的主要的控制流程：这就是你需要运行来启动应用的文件。模块文件就是工具的库，这些工具是用来收集顶层文件（或者其他可能的地方）使用的组件。顶层文件使用了在模块文件中定义的工具，而这些模块使用了其他模块所定义的工具。

### 导入和属性

```python
### file: b.py

def spam(text):
    print(text, 'spam')
```

```python
### file: a.py

import b
b.spam('gumby')
```

> 在一个导入语句中的模块名起到两个作用：识别加载的外部文档，但是它也会变成赋值给被载入模块的变量。

### 标准库模块

Python自带了很多实用的模块，称为标准链接库。这个集合体大约有200个模块，包含与平台不相关的常见程序设计任务：操作系统接口、对象永久保存、文字模式匹配、网络和Internet脚本、GUI建构等。

## import如何工作

> 有些C程序设计者喜欢把Python的模块导入操作比作C语言中的#include，但其实不应该这么比较：在Python中，导入并非只是把一个文件文本插入另一个文件而已。导入其实是运行时的运算，程序第一次导入指定文件时，会执行三个步骤。
> 
> 1.找到模块文件。
> 
> 2.编译成位码（需要时）。
> 
> 3.执行模块的代码来创建其所定义的对象。
> 
> 记住，这三个步骤只在程序执行时，模块第一次导入时才会进行。在这之后，导入相同模块时，会跳过这三个步骤，而只提取内存中已加载的模块对象。从技术上讲，Python把载入的模块存储到一个名为sys.modules的表中，并在一次导入操作的开始检查该表。如果模块不存在，将会启动一个三个步骤的过程。

```
>>> import sys
>>> sys.modules.keys()
['copy_reg', 'sre_compile', '_sre', 'encodings', 'site', '__builtin__', 'sysconfig', '__main__', 'encodings.encodings', 'abc', 'posixpath', '_weakrefset', 'errno', 'encodings.codecs', 'sre_constants', 're', '_abcoll', 'types', '_codecs', 'encodings.__builtin__', '_warnings', 'genericpath', 'stat', 'zipimport', '_sysconfigdata', 'warnings', 'UserDict', 'encodings.utf_8', 'sys', '_osx_support', 'codecs', 'readline', 'os.path', '_locale', 'signal', 'traceback', 'linecache', 'posix', 'encodings.aliases', 'exceptions', 'sre_parse', 'os', '_weakref']
```

## 模块搜索路径

> **1.程序的主目录。**
> 
> 这一入口的含义与你如何运行代码相关。当你运行一个程序的时候，这个入口是包含程序的顶层脚本文件的目录。当在交互模式下工作时，这一入口就是你当前工作的目录。
> 
> 由于这个目录是先搜索的，其文件也将覆盖路径上的其他目录中具有同样名称的模块。如果你需要在自己的程序中使用库模块的话，小心不要以这种方式意外地隐藏库模块。
> 
> **2.PYTHONPATH目录（如果已经进行了设置）。**
> 
> Python会从左至右（假设你的设置了的话）搜索PYTHONPATH环境变量设置中罗列出的所有目录。
> 
> **3.标准链接库目录。**
> 
> Python会自动搜索标准库模块安装在机器上的那些目录。
> 
> 
> **4.任何.pth文件的内容（如果存在的话）。**
> Python有个相当新的功能，允许用户把有效的目录添加到模块搜索路径中去，也就是在后缀名为.pth（路径的意思）的文本文件中一行一行地列出目录。

### 配置搜索路径

> 搜索路径的PYTHONPATH和路径文件部分允许我们调整导入查找文件的地方。设置环境变量的方法以及存储路径文件的位置，随着每种平台而变化。

以下示例是在 Mac 上配置环境变量 `PYTHONPATH`
```
PYTHONPATH=/path/to/directory
```

以下示例是用 `.pth` 文件的方式来进行配置
```
### fileL: C:\Python30\pydirs.pth
c:\pycode\utilities
d:\pycode\package1
```

### 搜索路径的变动

> 搜索路径的配置可能随平台以及Python版本而异。取决于你所使用的平台，附加的目录也可能自动加入模块搜索路径。
> 
> 想知道你的Python在平台上配置的模块搜索路径，可以查看sys.path，这是下一小节的主题。

### sys.path列表

```
>>> import sys
>>> sys.path
```

> 如果你知道在做什么，这个列表也提供一种方式，让脚本手动调整其搜索路径。然而，这种修改只会在脚本存在期间保持而已。PYTHONPATH和.pth文件提供了更持久的路径修改方法。

### 模块文件选择

> 记住，文件名的后缀（例如，.py）是刻意从import语句中省略的。Python会选择在搜索路径中第一个符合导入文件名的文件。例如，import b形式的import叙述可能会加载。
> 
> - 源代码文件b.py。
> - 字节码文件b.pyc。
> - 目录b，包导入（在第23章说明）。
> - 编译扩展模块（通常用C或C++编写），导入时使用动态连接（例如，Linux的b.so以及Cygwin和Windows的b.dll或b- pyd）。
> - 用C编写的编译好的内置模块，并通过静态连接至Python。
> - ZIP文件组件，导入时会自动解压缩。
> - 内存内映像，对于frozen可执行文件。
> - Java类，在Jython版本的Python中。
> - ·NET组件，在IronPython版本的Python中。

### 高级的模块选择概念

n/a

### 第三方工具：distutils

n/a

学习结束